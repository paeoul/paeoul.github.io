<!DOCTYPE html>

<!--
  No License Granted
  This project is all rights reserved. No license is granted for the reproduction, distribution, or modification of this work without my explicit consent.
  © 2026
-->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DokuSwift: Resistenztabelle</title>
    <link rel="icon" href="DS_resize.png" type="image/png" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Simple Transition Style for the Container (used for Disease switch only) */
      #table-container {
        transition: opacity 0.3s ease-in-out;
        opacity: 1; /* Default visible state */
      }

      /* Helper class to hide it during the switch */
      #table-container.fade-out {
        opacity: 0;
      }
    </style>
  </head>

  <body>
    <div id="dashboard">
      <div id="left-sidebar">
        <div id="disease-selection-container">
          <h3 class="sidebar-section-header">Diagnose</h3>

          <div class="select-wrapper">
            <select id="disease-selector"></select>
          </div>
        </div>

        <hr class="header-divider" />

        <div id="severity-container" style="display: none"></div>

        <hr class="sidebar-divider" />

        <div class="allergy-toggle-container" id="allergy-toggle-container">
          <div class="allergy-toggle-container-header">
            <h3 class="sidebar-section-header">Allergie-Filter</h3>
          </div>

          <div class="toggle-container" id="penicillin-toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="penicillin-toggle" />
              <span class="toggle-slider"></span>
            </label>
            <span class="allergy-toggle-label">nur Penicilline ausblenden</span>
          </div>

          <div class="toggle-container" id="blactam-toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="blactam-toggle" />
              <span class="toggle-slider"></span>
            </label>
            <span class="allergy-toggle-label">alle ß-Lactame ausblenden</span>
          </div>
        </div>

        <div id="three-way-toggle-container" style="display: none">
          <div class="three-way-toggle-header">
            <h3 class="sidebar-section-header">Antibiotika-Auswahl</h3>
          </div>
          <div class="three-way-toggle">
            <input type="radio" name="filterMode" id="filterMode0" value="0" />
            <label for="filterMode0">Alle</label>

            <input
              type="radio"
              name="filterMode"
              id="filterMode1"
              value="1"
              checked
            />
            <label for="filterMode1">Fokus</label>

            <input type="radio" name="filterMode" id="filterMode2" value="2" />
            <label for="filterMode2">Empfehlung</label>
          </div>
        </div>
      </div>

      <div id="header_table_container">
        <div id="header-container">
          <h1 id="dynamic-header">Antibiotikaresistenztabelle</h1>
          <div class="zoom-buttons">
            <div id="zoom-in" title="Vergrößern">+</div>
            <div id="zoom-out" title="Verkleinern">–</div>
          </div>
        </div>

        <div id="table-container"></div>
      </div>

      <div id="right-sidebar">
        <a class="img-container" href="index.html">
          <img src="finished_icon.png" alt="DokuSwift Logo" id="logo-img" />
        </a>

        <div id="sidebar-content"></div>

        <div class="impressum-container">
          <p class="impressum-text">
            <a href="impressum.html">Impressum</a>
          </p>
        </div>
      </div>
    </div>

    <div id="antibiotic-tooltip" style="display: none"></div>

    <div id="image-modal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="modal-image" />
      <div id="caption">Schweregradeinteilung</div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      // Desired order of antibiotics
      const desiredOrderAntibiotics = [
        "Penicillin G",
        "Pivmecillinam",
        "Flucloxacillin",
        "Amoxicillin",
        "Ampicillin",
        "Ampicillin Sulbactam",
        "Piperacillin Tazobactam",
        "Cefazolin",
        "Cefuroxim",
        "Cefpodoxim",
        "Ceftriaxon",
        "Cefotaxim",
        "Ceftazidim",
        "Cefepim",
        "Ceftazidime_Avibactam",
        "Ceftaroline",
        "Ceftolozane_Tazobactam",
        "Cefiderocol",
        "Imipenem",
        "Meropenem",
        "Ertapenem",
        "Ciprofloxacin",
        "Levofloxacin",
        "Moxifloxacin",
        "Azithromycin",
        "Clarithromycin",
        "Vancomycin",
        "Teicoplanin",
        "Gentamicin",
        "Doxycycline",
        "Clindamycin",
        "Cotrimoxazole",
        "Metronidazole",
        "Tigecycline",
        "Linezolid",
        "Daptomycin",
        "Rifampicin",
        "Fosfomycin",
        "Colistin",
        "Nitrofurantoin",
        "Trimethoprim",
        "Cotrimoxazol (HWI)",
      ];

      // Desired order of bacteria
      const desiredOrderBacteria = [
        "Streptococcus pneumoniae",
        "Streptococcus pyogenes",
        "Methicillinsensibler Staph. aureus (MSSA)",
        "Methicillinresistenter Staph. aureus (MRSA)",
        "Koagulasenegative Staphylokokken",
        "Staphylococcus saprophyticus",
        "Enterococcus faecalis",
        "Enterococcus faecium",
        "Listeria monocytogenes",
        "Escherichia coli",
        "Enterobacter cloacae",
        "Klebsiella spp.",
        "Proteus mirabilis",
        "Proteus vulgaris",
        "Citrobacter spp.",
        "Morganella morganii",
        "Serratia spp.",
        "Acinetobacter spp.",
        "Pseudomonas aeruginosa",
        "Stenotrophomonas maltophilia",
        "Salmonella spp.",
        "Shigella spp.",
        "Neisseria gonorrhoeae (Gonokokken)",
        "Neisseria meningitidis (Meningokokken)",
        "Haemophilus influenzae",
        "Bacteroides spp.",
        "Clostridioides difficile",
        "Chlamydophila pneumoniae",
        "Legionella spp.",
        "Mycoplasma pneumoniae",
      ];

      // Bacterial group data
      const bacteriaGroups = {
        "Streptococcus pneumoniae": "grampositiv",
        "Streptococcus pyogenes": "grampositiv",
        "Methicillinsensibler Staph. aureus (MSSA)": "grampositiv",
        "Methicillinresistenter Staph. aureus (MRSA)": "grampositiv",
        "Koagulasenegative Staphylokokken": "grampositiv",
        "Staphylococcus saprophyticus": "grampositiv",
        "Enterococcus faecalis": "grampositiv",
        "Enterococcus faecium": "grampositiv",
        "Listeria monocytogenes": "grampositiv",
        "Escherichia coli": "gramnegativ",
        "Enterobacter cloacae": "gramnegativ",
        "Klebsiella spp.": "gramnegativ",
        "Proteus mirabilis": "gramnegativ",
        "Proteus vulgaris": "gramnegativ",
        "Citrobacter spp.": "gramnegativ",
        "Morganella morganii": "gramnegativ",
        "Serratia spp.": "gramnegativ",
        "Acinetobacter spp.": "gramnegativ",
        "Pseudomonas aeruginosa": "gramnegativ",
        "Stenotrophomonas maltophilia": "gramnegativ",
        "Salmonella spp.": "gramnegativ",
        "Shigella spp.": "gramnegativ",
        "Neisseria gonorrhoeae (Gonokokken)": "gramnegativ",
        "Neisseria meningitidis (Meningokokken)": "gramnegativ",
        "Haemophilus influenzae": "gramnegativ",
        "Bacteroides spp.": "Anaerobier",
        "Clostridioides difficile": "Anaerobier",
        "Chlamydophila pneumoniae": "Atypiker",
        "Legionella spp.": "Atypiker",
        "Mycoplasma pneumoniae": "Atypiker",
      };

      // Define a fixed mapping of antibiotic groups to colors
      const groupToColor = {
        Penicilline: "#d6e3e1",
        Cephalosporine: "#b1c3c2",
        Carbapeneme: "#c7d9d7",
        Chinolone: "#d3eced",
        Makrolide: "#c7d2e4",
        Glykopeptide: "#deefe7",
        Sonstige: "#cbe0d6",
      };

      // Define a fixed mapping of bacterial groups to colors
      const bacteriaGroupColors = {
        grampositiv: "#bee3e6",
        gramnegativ: "#becde6",
        Anaerobier: "#e6ddf5",
        Atypiker: "#ddcdef",
      };

      // State variables
      let selectedSeverityLevel = null; // Track the selected severity level
      let penicillinAllergy = false; // Track the penicillin allergy toggle state
      let bLactamAllergy = false;
      let selectedDisease = null; // Currently selected disease
      let currentSeverityImage = null; // Variable to store the current disease's severity image path

      // Global data variables
      let diseaseConfig = {};
      let antibioticsData = {};
      let diseasePrevalenceData = {};
      let recommendationsData = {};
      let focusAntibioticsData = {};
      let highFocusAntibioticsData = {};
      let severityInfoData = {};
      let severityLevels = [];
      let diseaseRecommendations = {};
      let antibioticDosingData = {};
      let filterMode = 1;
      // 0 => no filter, 1 => focus, 2 => highFocus

      // Helper function to retrieve dose
      function getDoseForAntibiotic(antibioticName) {
        const doseInfo = antibioticDosingData[antibioticName];
        if (!doseInfo) {
          // No entry for this antibiotic => no tooltip
          return null;
        }

        // If no disease is selected, use default (if available)
        if (!selectedDisease) {
          return doseInfo.default || null;
        }

        // Otherwise, we have a disease; only show if there's disease-specific dosing
        return doseInfo[selectedDisease] || null;
      }

      function initThreeWayToggle() {
        const radioButtons = document.querySelectorAll(
          '.three-way-toggle input[type="radio"]'
        );
        radioButtons.forEach((rb) => {
          rb.addEventListener("change", function () {
            filterMode = parseInt(this.value, 10); // 0, 1, or 2
            // INSTANT CHANGE: No Fade
            createTable();
          });
        });
      }

      function updateFilterModeOptions() {
        const highFocusRadio = document.getElementById("filterMode2");
        const highFocusLabel = document.querySelector(
          'label[for="filterMode2"]'
        );

        if (!selectedDisease) {
          // Hide the third radio if no disease
          highFocusRadio.style.display = "none";
          highFocusLabel.style.display = "none";

          // If the user had it selected before, revert to "Alle" or "Fokus"
          if (filterMode === 2) {
            filterMode = 1; // e.g. reset to "Alle"
            document.getElementById("filterMode1").checked = true;
          }
        } else {
          // Show the third radio
          highFocusLabel.style.display = "flex";
          filterMode = 2;
          document.getElementById("filterMode2").checked = true;
        }
      }

      // Load disease_config and antibiotic_dosing together
      Promise.all([
        d3.json("disease_config.json"),
        d3.json("antibiotic_dosing.json"),
      ]).then(function ([config, dosingData]) {
        diseaseConfig = config;
        antibioticDosingData = dosingData; // global variable
        initializeDiseaseSelector(config);
      });

      function initializeDiseaseSelector(config) {
        const diseases = Object.keys(config);
        const diseaseSelector = d3.select("#disease-selector");

        // Add a default option to prompt user selection
        diseaseSelector
          .append("option")
          .attr("value", "")
          .attr("selected", true)
          .text("keine gewählt");

        diseaseSelector
          .selectAll("option.disease-option")
          .data(diseases)
          .enter()
          .append("option")
          .attr("class", "disease-option")
          .attr("value", (d) => d)
          .text((d) => d);

        initThreeWayToggle();
        document.getElementById("three-way-toggle-container").style.display =
          "block";

        // Load initial data without a specific disease (Immediate load for first time)
        loadDefaultData(false);
        updateFilterModeOptions();

        // Add event listener for disease selection
        diseaseSelector.on("change", function () {
          const newDisease = d3.select(this).property("value");

          // START FADE OUT IMMEDIATELY ON DISEASE CHANGE
          const container = d3.select("#table-container");
          container.classed("fade-out", true);

          // SHORT TIMEOUT TO ALLOW FADE TO START BEFORE DATA FETCH
          setTimeout(() => {
            selectedDisease = newDisease;
            if (selectedDisease === "") {
              selectedDisease = null;
            }
            // Update header
            updateHeader();

            if (selectedDisease === null) {
              // Pass true to indicate we want to animate the transition
              loadDefaultData(true);
              updateFilterModeOptions();
            } else {
              loadDiseaseData(selectedDisease, true);
              updateFilterModeOptions();
            }
          }, 50);
        });
      }

      // =================================================================
      //  NEW TRANSITION HELPER (Only used for Disease Switching now)
      // =================================================================
      function performUpdateWithFade(updateCallback) {
        const container = d3.select("#table-container");

        // 1. Fade Out
        container.classed("fade-out", true);

        // 2. Wait for fade (300ms matches CSS), then Update & Zoom, then Fade In
        setTimeout(() => {
          updateCallback();
          container.classed("fade-out", false);
        }, 300);
      }

      function loadDefaultData(animate) {
        currentSeverityImage = null;

        const dataPromise = Promise.all([
          d3.json("antibiotics_data.json"),
          d3.json("default_prevalence.json"),
          d3.json("default_focus_antibiotics.json"),
        ]);

        dataPromise.then(function ([
          loadedAntibioticsData,
          loadedPrevalenceData,
          loadedFocusAntibioticsData,
        ]) {
          const updateLogic = () => {
            antibioticsData = loadedAntibioticsData;
            diseasePrevalenceData = loadedPrevalenceData;
            focusAntibioticsData = loadedFocusAntibioticsData;

            selectedSeverityLevel = null;
            severityLevels = [];
            penicillinAllergy = false;

            d3.select("#severity-container").style("display", "none");
            d3.select("#allergy-toggle-container").classed("visible", false);
            updateRightSidebar(null);

            d3.select("#penicillin-toggle").property("checked", false);
            d3.select("#blactam-toggle").property("checked", false);

            init(); // Builds table and zooms
          };

          if (animate) {
            // We are already faded out from the change listener, just run logic and fade in
            setTimeout(() => {
              updateLogic();
              d3.select("#table-container").classed("fade-out", false);
            }, 300);
          } else {
            // Immediate load (first run)
            updateLogic();
          }
        });
      }

      function loadDiseaseData(disease, animate) {
        const diseaseSettings = diseaseConfig[disease];
        currentSeverityImage = diseaseSettings.severityImage || null;

        const dataPromise = Promise.all([
          d3.json(diseaseSettings.dataFile),
          d3.json(diseaseSettings.prevalenceFile),
          d3.json(diseaseSettings.recommendationsFile),
          d3.json(diseaseSettings.focusAntibioticsFile),
          d3.json(diseaseSettings.highFocusAntibioticsFile),
          d3.json(diseaseSettings.severityInfoFile),
        ]);

        dataPromise.then(function ([
          loadedAntibioticsData,
          loadedPrevalenceData,
          loadedRecommendationsData,
          loadedFocusAntibioticsData,
          loadedHighFocusAntibioticsData,
          loadedSeverityInfoData,
        ]) {
          const updateLogic = () => {
            antibioticsData = loadedAntibioticsData;
            diseasePrevalenceData = loadedPrevalenceData;
            recommendationsData = loadedRecommendationsData;
            focusAntibioticsData = loadedFocusAntibioticsData;
            highFocusAntibioticsData = loadedHighFocusAntibioticsData;
            severityInfoData = loadedSeverityInfoData;

            severityLevels = diseaseSettings.severityLevels;
            selectedSeverityLevel = null;
            penicillinAllergy = false;
            bLactamAllergy = false; // NEW: Explicitly reset variable

            updateRightSidebar(null);

            // NEW: RESET DOM ELEMENTS (Crucial for UI sync)
            d3.select("#penicillin-toggle").property("checked", false);
            d3.select("#blactam-toggle").property("checked", false);
            d3.select("#severity-container").style("display", "flex");
            createSeverityButtons();

            init(); // Builds table and zooms
          };

          if (animate) {
            setTimeout(() => {
              updateLogic();
              d3.select("#table-container").classed("fade-out", false);
            }, 300);
          } else {
            updateLogic();
          }
        });
      }

      function showAntibioticTooltip(referenceElement, text) {
        const tooltip = document.getElementById("antibiotic-tooltip");
        tooltip.innerHTML = text;
        tooltip.style.display = "block";

        const tooltipRect = tooltip.getBoundingClientRect();
        const tooltipHeight = tooltipRect.height;
        const tooltipWidth = tooltipRect.width;
        const refRect = referenceElement.getBoundingClientRect();

        tooltip.style.top = `${window.scrollY + refRect.bottom + 10}px`;
        const leftPos =
          refRect.left + refRect.width / 2 - tooltipWidth / 2 + window.scrollX;
        tooltip.style.left = `${leftPos}px`;
        tooltip.style.setProperty("--arrow-left", `${tooltipWidth / 2}px`);
      }

      function hideAntibioticTooltip() {
        const tooltip = document.getElementById("antibiotic-tooltip");
        tooltip.style.display = "none";
      }

      function init() {
        d3.select("#penicillin-toggle").on("change", function (event) {
          penicillinAllergy = d3.select(this).property("checked");
          updateRecommendationsHighlighting();
        });

        d3.select("#blactam-toggle").on("change", function (event) {
          bLactamAllergy = d3.select(this).property("checked");
          updateRecommendationsHighlighting();
        });

        createTable();
      }

      // Maps to store references
      const bacteriumHeaderCells = {};
      const dataCellsByBacterium = {};
      const antibioticNameCells = {};
      let lockedAntibiotic = null;

      function highlightAntibiotic(antibiotic) {
        const antibioticNameCell = antibioticNameCells[antibiotic];
        if (!antibioticNameCell) return;

        antibioticNameCell.classed("antibiotic-name-hover", true);
        d3.select(antibioticNameCell.node().parentNode).classed(
          "highlighted-row",
          true
        );

        const entry = findAntibioticEntryByName(antibiotic);
        if (!entry) return;

        const sensitivities = entry.sensitivities;
        for (const bacterium in sensitivities) {
          const val = sensitivities[bacterium];
          if (bacteriumHeaderCells[bacterium]) {
            if (val === 0.0) {
              bacteriumHeaderCells[bacterium].classed(
                "bacterium-low-sensitivity",
                true
              );
            } else if (val === 0.5) {
              bacteriumHeaderCells[bacterium].classed(
                "bacterium-intermedium-sensitivity",
                true
              );
            } else if (val === 1.0) {
              bacteriumHeaderCells[bacterium].classed(
                "bacterium-high-sensitivity",
                true
              );
            }
          }
        }
      }

      function unhighlightAntibiotic(antibiotic) {
        const antibioticNameCell = antibioticNameCells[antibiotic];
        if (!antibioticNameCell) return;

        antibioticNameCell.classed("antibiotic-name-hover", false);
        d3.select(antibioticNameCell.node().parentNode).classed(
          "highlighted-row",
          false
        );

        const entry = findAntibioticEntryByName(antibiotic);
        if (!entry) return;

        const sensitivities = entry.sensitivities;
        for (const bacterium in sensitivities) {
          if (bacteriumHeaderCells[bacterium]) {
            bacteriumHeaderCells[bacterium]
              .classed("bacterium-low-sensitivity", false)
              .classed("bacterium-intermedium-sensitivity", false)
              .classed("bacterium-high-sensitivity", false);
          }
        }
      }

      function lockAntibiotic(antibiotic) {
        if (lockedAntibiotic && lockedAntibiotic !== antibiotic) {
          unhighlightAntibiotic(lockedAntibiotic);
        }
        lockedAntibiotic = antibiotic;
        highlightAntibiotic(antibiotic);
      }

      function clearLockedAntibiotic() {
        if (lockedAntibiotic) {
          unhighlightAntibiotic(lockedAntibiotic);
          lockedAntibiotic = null;
        }
      }

      let globalAntibioticsList = [];

      function findAntibioticEntryByName(antibioticName) {
        return (
          globalAntibioticsList.find((e) => e.antibiotic === antibioticName) ||
          null
        );
      }

      function createSeverityButtons() {
        const container = d3.select("#severity-container");
        container.html("");

        // 1. Create the Header Row Container
        const headerRow = container
          .append("div")
          .attr("class", "severity-header-row");

        // 2. Add the Header: "EINTEILUNG"
        headerRow
          .append("h3")
          .attr("class", "sidebar-section-header")
          .style("margin", "0") // Reset margin so it aligns with the link
          .text("EINTEILUNG");

        // 3. Add the Link: "(i) Info" (Only if image exists)
        if (currentSeverityImage) {
          headerRow
            .append("a")
            .attr("href", "#")
            .attr("id", "einteilung-link") // Keeping ID same preserves event logic below
            .attr("class", "einteilung-link")
            .html("<span class='info-icon-small'>i</span> Info");
        }

        container
          .selectAll(".severity-button")
          .data(severityLevels)
          .enter()
          .append("button")
          .attr("class", "severity-button")
          .html((d) => d)
          .on("click", function (event, d) {
            if (selectedSeverityLevel === d) {
              selectedSeverityLevel = null;
              d3.select(this).classed("pressed", false);
              updateRightSidebar(null);
            } else {
              container.selectAll(".severity-button").classed("pressed", false);
              selectedSeverityLevel = d;
              d3.select(this).classed("pressed", true);
              updateRightSidebar(d);
            }
            updateRecommendationsHighlighting();
          });

        const einteilungLink = document.getElementById("einteilung-link");
        const modal = document.getElementById("image-modal");
        const modalImg = document.getElementById("modal-image");
        const captionText = document.getElementById("caption");
        const closeBtn = document.getElementsByClassName("close")[0];

        if (einteilungLink) {
          einteilungLink.onclick = function (event) {
            event.preventDefault();
            if (currentSeverityImage) {
              modal.style.display = "block";
              modalImg.src = currentSeverityImage;
              captionText.innerHTML = "Einteilung";
            } else {
              alert("Keine Schweregradeinteilung verfügbar.");
            }
          };
        }

        if (closeBtn) {
          closeBtn.onclick = function () {
            modal.style.display = "none";
          };
        }

        window.onclick = function (event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        };

        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            modal.style.display = "none";
          }
        });
      }

      function updateRightSidebar(severityLevel) {
        const sidebarContent = d3.select("#sidebar-content");
        sidebarContent.selectAll("*").remove();

        if (severityLevel && severityInfoData[severityLevel]) {
          sidebarContent
            .append("div")
            .attr("class", "sidebar-tag")
            .text("Leitlinienempfehlung");

          const info = severityInfoData[severityLevel];

          sidebarContent
            .append("h3")
            .attr("class", "right-sidebar-title")
            .text(info.title);

          sidebarContent
            .append("div")
            .attr("class", "right-sidebar-content")
            .html(info.content);

          if (info.image) {
            sidebarContent
              .append("img")
              .attr("src", info.image)
              .attr("alt", info.title)
              .attr("class", "right-sidebar-image");
          }

          if (info.table) {
            const table = sidebarContent
              .append("table")
              .attr("class", "right-sidebar-table");
            const thead = table.append("thead");
            const headerRow = thead.append("tr");
            headerRow
              .selectAll("th")
              .data(info.table.headers)
              .enter()
              .append("th")
              .text((d) => d);

            const tbody = table.append("tbody");
            info.table.rows.forEach((rowData) => {
              const row = tbody.append("tr");
              row
                .selectAll("td")
                .data(rowData)
                .enter()
                .append("td")
                .text((d) => d);
            });
          }
        } else {
          sidebarContent.selectAll("*").remove();
        }
      }

      function createTable() {
        // Remove existing table
        d3.select("#table-container").select("table").remove();

        const container = d3.select("#table-container");

        const bacteriaSet = new Set();
        const antibioticToGroup = {};

        for (const group in antibioticsData) {
          for (const antibiotic in antibioticsData[group]) {
            antibioticToGroup[antibiotic] = group;
            for (const bacterium in antibioticsData[group][antibiotic]) {
              bacteriaSet.add(bacterium);
            }
          }
        }

        let bacteria = Array.from(bacteriaSet);

        if (selectedDisease) {
          bacteria = bacteria.filter(
            (bacterium) => bacterium in diseasePrevalenceData
          );
        }

        bacteria.sort((a, b) => {
          const indexA = desiredOrderBacteria.indexOf(a);
          const indexB = desiredOrderBacteria.indexOf(b);
          if (indexA === -1 && indexB === -1) return 0;
          if (indexA === -1) return 1;
          if (indexB === -1) return -1;
          return indexA - indexB;
        });

        let bacteriaGroupsOrdered = [];
        let currentGroup = null;

        bacteria.forEach((bacterium, index) => {
          const group = bacteriaGroups[bacterium] || "Unknown";
          const isGroupStart = group !== currentGroup;
          if (isGroupStart) {
            currentGroup = group;
          }
          bacteriaGroupsOrdered.push({
            name: bacterium,
            group: group,
            isGroupStart: isGroupStart,
          });
        });

        let groupSpans = [];
        currentGroup = null;
        let currentSpan = 0;

        bacteriaGroupsOrdered.forEach((bacteriumData, index) => {
          if (bacteriumData.group !== currentGroup) {
            if (currentGroup !== null) {
              groupSpans.push({
                group: currentGroup,
                span: currentSpan,
              });
            }
            currentGroup = bacteriumData.group;
            currentSpan = 1;
          } else {
            currentSpan++;
          }
          if (index === bacteriaGroupsOrdered.length - 1) {
            groupSpans.push({
              group: currentGroup,
              span: currentSpan,
            });
          }
        });

        let antibiotics = desiredOrderAntibiotics
          .map((antibiotic) => {
            const group = antibioticToGroup[antibiotic];
            if (group && antibioticsData[group][antibiotic]) {
              return {
                group: group,
                antibiotic: antibiotic,
                sensitivities: antibioticsData[group][antibiotic],
              };
            } else {
              return null;
            }
          })
          .filter((entry) => entry !== null);

        switch (filterMode) {
          case 0:
            break;
          case 1:
            antibiotics = antibiotics.filter((entry) =>
              focusAntibioticsData.focus_antibiotics.includes(entry.antibiotic)
            );
            break;
          case 2:
            if (
              selectedDisease &&
              highFocusAntibioticsData &&
              highFocusAntibioticsData.high_focus_antibiotics
            ) {
              antibiotics = antibiotics.filter((entry) =>
                highFocusAntibioticsData.high_focus_antibiotics.includes(
                  entry.antibiotic
                )
              );
            }
            break;
        }

        globalAntibioticsList = antibiotics;

        const groupCounts = {};
        antibiotics.forEach((entry) => {
          if (groupCounts[entry.group]) {
            groupCounts[entry.group]++;
          } else {
            groupCounts[entry.group] = 1;
          }
        });

        const prevalenceData = diseasePrevalenceData;
        let totalPrevalence = 0;
        for (const bacterium of bacteria) {
          totalPrevalence += prevalenceData[bacterium] || 0;
        }

        const totalBacteriaWidth = window.innerWidth - 800;

        const bacteriaWidths = {};
        for (const bacterium of bacteria) {
          const prevalence = prevalenceData[bacterium] || 0;
          const widthPx = (prevalence / totalPrevalence) * totalBacteriaWidth;
          bacteriaWidths[bacterium] = widthPx;
        }

        const table = container.append("table");
        const colgroup = table.append("colgroup");

        colgroup
          .append("col")
          .attr("class", "group-col")
          .style("width", "135px");
        colgroup
          .append("col")
          .attr("class", "antibiotic-col")
          .style("width", "135px");

        colgroup
          .selectAll("col.bacterium-col")
          .data(bacteriaGroupsOrdered)
          .enter()
          .append("col")
          .attr("class", "bacterium-col")
          .style("width", (d) => bacteriaWidths[d.name] + "px");

        const thead = table.append("thead");
        const groupHeaderRow = thead.append("tr");
        groupHeaderRow.append("th").attr("colspan", 2);

        groupHeaderRow
          .selectAll("th.bacteria-group")
          .data(groupSpans)
          .enter()
          .append("th")
          .attr("class", (d, i) => {
            let classes = "bacteria-group";
            if (i === 0 || i > 0) {
              classes += " bacterial-group-start";
            }
            return classes;
          })
          .attr("colspan", (d) => d.span)
          .style(
            "background-color",
            (d) => bacteriaGroupColors[d.group] || "#e2e3e5"
          )
          .text((d) => d.group);

        const headerRow = thead.append("tr");
        headerRow.append("th").text("");
        headerRow.append("th").text("");

        headerRow
          .selectAll("th.bacterium")
          .data(bacteriaGroupsOrdered)
          .enter()
          .append("th")
          .attr("class", (d) => {
            let classes = "bacterium";
            if (d.isGroupStart) {
              classes += " bacterial-group-start";
            }
            return classes;
          })
          .style(
            "background-color",
            (d) => bacteriaGroupColors[d.group] || "#f2f2f2"
          )
          .text((d) => d.name)
          .each(function (d) {
            bacteriumHeaderCells[d.name] = d3.select(this);
          })
          .on("mouseover", function (event, d) {
            if (lockedAntibiotic !== null) return;
            const bacterium = d.name;
            d3.select(this).classed("bacterium-name-hover", true);

            const dataCells = dataCellsByBacterium[bacterium];
            if (dataCells) {
              dataCells.forEach((cellData) => {
                cellData.cell.classed("highlighted-column", true);
              });
            }

            antibiotics.forEach((entry) => {
              const sensitivity = entry.sensitivities
                ? entry.sensitivities[bacterium]
                : null;
              const antibioticNameCell = antibioticNameCells[entry.antibiotic];
              if (sensitivity === 0.0) {
                antibioticNameCell.classed("antibiotic-low-sensitivity", true);
              } else if (sensitivity === 0.5) {
                antibioticNameCell.classed(
                  "antibiotic-intermedium-sensitivity",
                  true
                );
              } else if (sensitivity === 1.0) {
                antibioticNameCell.classed("antibiotic-high-sensitivity", true);
              } else if (sensitivity === null) {
                antibioticNameCell.classed(
                  "antibiotic-unknown-sensitivity",
                  true
                );
              }
            });
          })
          .on("mouseout", function (event, d) {
            if (lockedAntibiotic !== null) return;
            const bacterium = d.name;
            d3.select(this).classed("bacterium-name-hover", false);

            const dataCells = dataCellsByBacterium[bacterium];
            if (dataCells) {
              dataCells.forEach((cellData) => {
                cellData.cell.classed("highlighted-column", false);
              });
            }

            antibiotics.forEach((entry) => {
              const antibioticNameCell = antibioticNameCells[entry.antibiotic];
              antibioticNameCell.classed("antibiotic-low-sensitivity", false);
              antibioticNameCell.classed(
                "antibiotic-intermedium-sensitivity",
                false
              );
              antibioticNameCell.classed("antibiotic-high-sensitivity", false);
              antibioticNameCell.classed(
                "antibiotic-unknown-sensitivity",
                false
              );
            });
          });

        const tbody = table.append("tbody");
        let previousGroup = null;

        antibiotics.forEach((entry) => {
          const row = tbody.append("tr");

          if (entry.group !== previousGroup) {
            row.classed("antibiotic-group-start", true);
            row
              .append("td")
              .attr("class", "group-name")
              .attr("rowspan", groupCounts[entry.group])
              .style("background-color", groupToColor[entry.group])
              .text(entry.group);
            previousGroup = entry.group;
          }

          const antibioticNameCell = row
            .append("td")
            .attr("class", "antibiotic-name")
            .style("background-color", groupToColor[entry.group])
            .text(entry.antibiotic)
            .datum(entry.antibiotic)
            .on("mouseover", function () {
              if (lockedAntibiotic !== null) return;
              d3.select(this).classed("antibiotic-name-hover", true);
              d3.select(this.parentNode).classed("highlighted-row", true);

              const sensitivities = entry.sensitivities;
              for (const bacterium in sensitivities) {
                if (sensitivities[bacterium] === 0.0) {
                  if (bacteriumHeaderCells[bacterium]) {
                    bacteriumHeaderCells[bacterium].classed(
                      "bacterium-low-sensitivity",
                      true
                    );
                  }
                } else if (sensitivities[bacterium] === 0.5) {
                  if (bacteriumHeaderCells[bacterium]) {
                    bacteriumHeaderCells[bacterium].classed(
                      "bacterium-intermedium-sensitivity",
                      true
                    );
                  }
                } else if (sensitivities[bacterium] === 1.0) {
                  if (bacteriumHeaderCells[bacterium]) {
                    bacteriumHeaderCells[bacterium].classed(
                      "bacterium-high-sensitivity",
                      true
                    );
                  }
                }
              }
            })
            .on("mouseout", function () {
              if (lockedAntibiotic !== null) return;
              d3.select(this).classed("antibiotic-name-hover", false);
              d3.select(this.parentNode).classed("highlighted-row", false);

              const sensitivities = entry.sensitivities;
              for (const bacterium in sensitivities) {
                if (bacteriumHeaderCells[bacterium]) {
                  bacteriumHeaderCells[bacterium].classed(
                    "bacterium-low-sensitivity",
                    false
                  );
                  bacteriumHeaderCells[bacterium].classed(
                    "bacterium-intermedium-sensitivity",
                    false
                  );
                  bacteriumHeaderCells[bacterium].classed(
                    "bacterium-high-sensitivity",
                    false
                  );
                }
              }
            })
            .on("click", function (event, antibioticName) {
              event.stopPropagation();
              if (lockedAntibiotic === antibioticName) {
                clearLockedAntibiotic();
                hideAntibioticTooltip();
              } else {
                lockAntibiotic(antibioticName);
                hideAntibioticTooltip();
                const dose = getDoseForAntibiotic(antibioticName);
                if (dose) {
                  const pillMarker = this.querySelector(".pill-marker");
                  const referenceElement = pillMarker || this;
                  showAntibioticTooltip(referenceElement, dose);
                }
              }
            });

          const dose = getDoseForAntibiotic(entry.antibiotic);
          if (dose) {
            antibioticNameCell.append("span").attr("class", "pill-marker");
          }

          antibioticNameCells[entry.antibiotic] = antibioticNameCell;

          bacteriaGroupsOrdered.forEach((bacteriumData, index) => {
            const bacterium = bacteriumData.name;
            const isGroupStart = bacteriumData.isGroupStart;
            const sensitivity = entry.sensitivities[bacterium];
            const cell = row
              .append("td")
              .attr("class", () => {
                let classes = "data-cell";
                if (isGroupStart) {
                  classes += " bacterial-group-start";
                }
                if (sensitivity === 1.0) {
                  classes += " sensitivity-high";
                } else if (sensitivity === 0.5) {
                  classes += " sensitivity-medium";
                } else if (sensitivity === 0.0) {
                  classes += " sensitivity-low";
                } else if (sensitivity == null) {
                  classes += " sensitivity-unknown";
                }
                return classes;
              })
              .datum({
                antibiotic: entry.antibiotic,
                bacterium: bacterium,
                sensitivity: sensitivity,
              })
              .on("mouseover", function (event, d) {
                if (lockedAntibiotic !== null) return;
                const cellData = d3.select(this).datum();
                const antibiotic = cellData.antibiotic;
                const bacterium = cellData.bacterium;

                d3.select(this).classed("data-cell-hover", true);

                if (antibioticNameCells[antibiotic]) {
                  antibioticNameCells[antibiotic].classed(
                    "antibiotic-name-hover",
                    true
                  );
                  d3.select(
                    antibioticNameCells[antibiotic].node().parentNode
                  ).classed("highlighted-row", true);
                }

                if (bacteriumHeaderCells[bacterium]) {
                  bacteriumHeaderCells[bacterium].classed(
                    "bacterium-name-hover",
                    true
                  );
                }

                d3.select(this.parentNode)
                  .selectAll("td.data-cell")
                  .classed("highlighted-row", true);

                const dataCells = dataCellsByBacterium[bacterium];
                if (dataCells) {
                  dataCells.forEach((cellData) => {
                    cellData.cell.classed("highlighted-column", true);
                  });
                }
              })
              .on("mouseout", function (event, d) {
                if (lockedAntibiotic !== null) return;
                const cellData = d3.select(this).datum();
                const antibiotic = cellData.antibiotic;
                const bacterium = cellData.bacterium;

                d3.select(this).classed("data-cell-hover", false);

                if (antibioticNameCells[antibiotic]) {
                  antibioticNameCells[antibiotic].classed(
                    "antibiotic-name-hover",
                    false
                  );
                  d3.select(
                    antibioticNameCells[antibiotic].node().parentNode
                  ).classed("highlighted-row", false);
                }

                if (bacteriumHeaderCells[bacterium]) {
                  bacteriumHeaderCells[bacterium].classed(
                    "bacterium-name-hover",
                    false
                  );
                }

                d3.select(this.parentNode)
                  .selectAll("td.data-cell")
                  .classed("highlighted-row", false);

                const dataCells = dataCellsByBacterium[bacterium];
                if (dataCells) {
                  dataCells.forEach((cellData) => {
                    cellData.cell.classed("highlighted-column", false);
                  });
                }
              });

            cell.text("");
            if (!dataCellsByBacterium[bacterium]) {
              dataCellsByBacterium[bacterium] = [];
            }
            dataCellsByBacterium[bacterium].push({
              cell: cell,
              sensitivity: sensitivity,
              antibiotic: entry.antibiotic,
            });
          });
        });

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".antibiotic-name")) {
            clearLockedAntibiotic();
            hideAntibioticTooltip();
          }
        });

        updateRecommendationsHighlighting();
        autoAdjustZoom();
      }

      function updateRecommendationsHighlighting() {
        // 1. Define the D3 reference at the top
        const allergyContainer = d3.select("#allergy-toggle-container");

        if (!selectedSeverityLevel) {
          // --- RESET STATE (No Selection) ---
          d3.selectAll(".antibiotic-name")
            .classed("primary-recommendation", false)
            .classed("secondary-recommendation", false)
            .classed("tertiary-recommendation", false);

          // FIX: Use class to slide up (hide)
          allergyContainer.classed("visible", false);

          // CRITICAL: Return early so the rest of the code doesn't crash
          return;
        } else {
          // FIX: Use class to slide down (show)
          allergyContainer.classed("visible", true);
        }

        // --- HIGHLIGHT LOGIC (Selection Exists) ---

        // 2. Determine which allergy key to use
        let allergyKey = "no_penicillin_allergy";

        if (penicillinAllergy && !bLactamAllergy) {
          allergyKey = "penicillin_allergy";
        } else if (!penicillinAllergy && bLactamAllergy) {
          allergyKey = "b_lactam_allergy";
        } else if (penicillinAllergy && bLactamAllergy) {
          allergyKey = "b_lactam_allergy";
        }

        // 3. Get the data
        const recommendations =
          recommendationsData[selectedSeverityLevel][allergyKey];
        const primary = recommendations.primary_recommendation || [];
        const secondary = recommendations.secondary_recommendation || [];
        const tertiary = recommendations.tertiary_recommendation || [];

        // 4. Apply the highlight classes
        d3.selectAll(".antibiotic-name")
          .classed("primary-recommendation", function () {
            const antibiotic = d3.select(this).datum();
            return primary.includes(antibiotic);
          })
          .classed("secondary-recommendation", function () {
            const antibiotic = d3.select(this).datum();
            return secondary.includes(antibiotic);
          })
          .classed("tertiary-recommendation", function () {
            const antibiotic = d3.select(this).datum();
            return tertiary.includes(antibiotic);
          });
      }

      function updateHeader() {
        const header = d3.select("#dynamic-header");
        if (selectedDisease) {
          header.text("Filter: " + selectedDisease);
        } else {
          header.text("Antibiotikaresistenztabelle");
        }
      }

      // ///////////////////// Zoom function ///////////////////////////
      let currentZoom = 1;

      function applyZoom() {
        const tableContainer = document.getElementById("table-container");
        tableContainer.style.zoom = currentZoom;
      }

      document.getElementById("zoom-in").addEventListener("click", () => {
        currentZoom += 0.05;
        applyZoom();
      });

      document.getElementById("zoom-out").addEventListener("click", () => {
        currentZoom = Math.max(0.5, currentZoom - 0.05);
        applyZoom();
      });

      function autoAdjustZoom() {
        const tableEl = document.querySelector("#table-container table");
        const containerEl = document.getElementById("table-container");
        if (!tableEl || !containerEl) return;

        // 1. Measure the CURRENT dimensions (already zoomed)
        let tableRect = tableEl.getBoundingClientRect();
        let containerRect = containerEl.getBoundingClientRect();

        // 2. Calculate the "Natural" (100%) width mathematically
        // Natural Width = Current Rendered Width / Current Zoom Factor
        const naturalTableWidth = tableRect.width / currentZoom;

        // 3. Calculate target based on the natural width
        // Math.min(1.0, ...) ensures we don't stretch small tables
        let targetZoom = Math.min(
          1.0,
          (containerRect.width - 32) / naturalTableWidth
        );

        // 4. Clamp strictly between 0.25 and 2.0
        currentZoom = Math.max(0.25, Math.min(2.0, targetZoom));

        // 5. Apply the new zoom only once
        applyZoom();
      }

      // /////////////////////////////////////////////////////////////////////////////

      document.addEventListener("DOMContentLoaded", function () {
        const diseaseContainer = document.getElementById(
          "disease-selection-container"
        );
        diseaseContainer.classList.add("animated");

        setTimeout(() => {
          diseaseContainer.classList.remove("animated");
        }, 4000);

        window.addEventListener("resize", function () {
          if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
          this.resizeTimeout = setTimeout(function () {
            autoAdjustZoom();
          }, 200);
        });
      });
    </script>
  </body>
</html>
